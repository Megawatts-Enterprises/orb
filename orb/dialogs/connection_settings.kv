#:import dp kivy.metrics.dp
#:import pref orb.misc.utils.pref
#:import Window kivy.core.window.Window
#:import Clipboard kivy.core.clipboard.Clipboard


<ConnectionSettings>:
    title: 'LND Node Connection Settings'
    size: min(dp(800), Window.size[0]), min(dp(500), Window.size[1])
    background_color: .6, .6, .8, .9
    overlay_color: 0, 0, 0, 0
    size_hint: [None, None]
    MDTabs:
        id: tabs
        on_tab_switch: root.on_tab_switch(*args)
        Tab:
            title: 'Address'
            BoxLayout:
                orientation: 'vertical'
                MDLabel:
                    text: 'Enter the IP address or hostname of your LND node. It should not be an FQDN (e.g it should not contain https:// etc.).'
                    size_hint_y: 1
                    multiline: True
                BoxLayout:
                    orientation: 'horizontal'
                    height: dp(60)
                    size_hint_y: None
                    MDTextField:
                        id: address
                        text: pref('lnd.hostname')
                        helper_text: 'Host Address'
                        helper_text_mode: "persistent"
                        height: dp(60)
                        width: dp(200)
                        size_hint: (None, None)
                    MDRaisedButton:
                        text: 'Save'
                        on_release: root.set_and_save('lnd.hostname', address.text)
                        size_hint_x: None
                        width: dp(100)
                        height: dp(40)
                        md_bg_color: 0.3,0.3,0.3,1
                MDLabel:
                    text: 'Once save, you can proceed onto the next tab.'
                    size_hint_y: 1
        Tab:
            title: 'Protocol'
            BoxLayout:
                orientation: 'vertical'
                size_hint: (1, 1)
                MDLabel:
                    text: 'Enter the protocol for your LND node. If you are on a desktop, you man use GRPC. On mobile, you must select REST.'
                    size_hint_y: 1
                    multiline: True
                BoxLayout:
                    orientation: 'horizontal'
                    BoxLayout:
                        orientation: 'vertical'
                        MDSwitch:
                            id: rest
                            on_release: root.save_protocol('rest')
                            active: pref('lnd.protocol') == 'rest'
                        MDLabel:
                            text: 'REST'
                    BoxLayout:
                        orientation: 'vertical'
                        MDSwitch:
                            id: grpc
                            on_release: root.save_protocol('grpc')
                            active: pref('lnd.protocol') == 'grpc'
                        MDLabel:
                            text: 'GRPC'
                    BoxLayout:
                        orientation: 'vertical'
                        MDSwitch:
                            id: mock
                            on_release: root.save_protocol('mock')
                            active: pref('lnd.protocol') == 'mock'
                        MDLabel:
                            text: 'MOCK'
                MDLabel:
                    text: 'Once entered, you can proceed onto the next tab.'
                    size_hint_y: 1
        Tab:
            title: 'Port'
            BoxLayout:
                orientation: 'vertical'
                MDLabel:
                    text: 'Enter the port # to connect your LND node. This is typically 8080 for REST, and 10009 for GRPC.'
                    size_hint_y: 0.1
                    multiline: True
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: 0.8
                    MDTextField:
                        id: rest_port
                        text: str(int(pref('lnd.rest_port')))
                        helper_text: 'REST Port #'
                        helper_text_mode: "persistent"
                        height: dp(60)
                        width: dp(200)
                        size_hint: (None, None)
                    MDTextField:
                        id: grpc_port
                        text: str(int(pref('lnd.grpc_port')))
                        helper_text: 'GRPC Port #'
                        helper_text_mode: "persistent"
                        height: dp(60)
                        width: dp(200)
                        size_hint: (None, None)
                    MDRaisedButton:
                        text: 'Save'
                        on_release: (root.set_and_save('lnd.rest_port', rest_port.text), root.set_and_save('lnd.grpc_port', grpc_port.text))
                        size_hint_x: None
                        width: dp(100)
                        height: dp(40)
                        md_bg_color: 0.3,0.3,0.3,1
                MDLabel:
                    text: 'Once saved, you can proceed onto the next tab.'
                    size_hint_y: 0.1
        Tab:
            title: 'TLS Certificate'
            BoxLayout:
                orientation: 'vertical'
                size_hint: (1, 1)
                MDLabel:
                    text: "Paste your TLS Certificate in plain text or base64. Orb will make sure it's valid upon saving. You can copy and run the provided command on your node."
                    size_hint_y: 0.3
                    multiline: True
                MDIconButton:
                    icon: "content-copy"
                    size_hint_y: 0.2
                    on_release: Clipboard.copy("""python3 -c 'import base64; print(base64.b64encode(open(".lnd/tls.cert").read().encode()).decode())'""")
                TextInput:
                    id: tls_cert
                    text: root.get_cert()
                    on_text: root.validate_cert(self.text)
                    size_hint_y: 0.4
                    multiline: True
                    size_hint: (1, 1)
                MDLabel:
                    id: feedback
                    text: ""
                    size_hint_y: 0.1
                    multiline: True
                MDRaisedButton:
                    text: 'Save'
                    on_release: root.save_cert(tls_cert.text)
                    size_hint: (None, None)
                    width: dp(100)
                    height: dp(40)
                    md_bg_color: 0.3,0.3,0.3,1
                MDLabel:
                    text: 'Once saved, you can proceed onto the next tab.'
                    size_hint_y: 0.1
        Tab:
            title: 'Macaroon'
            BoxLayout:
                orientation: 'vertical'
                size_hint: (1, 1)
                MDLabel:
                    text: "Paste your hex encoded macaroon. Orb will make sure it's valid upon saving. You can copy and run the provided command on your node."
                    size_hint_y: 0.3
                    multiline: True
                MDIconButton:
                    icon: "content-copy"
                    size_hint_y: 0.2
                    on_release: Clipboard.copy("""python3 -c 'import codecs; print(codecs.encode(open(".lnd/data/chain/bitcoin/mainnet/admin.macaroon", "rb").read(), "hex").decode())'""")
                TextInput:
                    id: macaroon
                    text: root.get_macaroon()
                    helper_text: 'Macaroon'
                    helper_text_mode: "persistent"
                    on_text: root.validate_macaroon(self.text)
                    size_hint_y: 0.4
                    multiline: True
                    size_hint: (1, 1)
                MDLabel:
                    id: mac_feedback
                    text: ""
                    size_hint_y: 0.1
                    multiline: True
                MDRaisedButton:
                    text: 'Save'
                    on_release: root.save_macaroon(macaroon.text)
                    size_hint: (None, None)
                    width: dp(100)
                    height: dp(40)
                    md_bg_color: 0.3,0.3,0.3,1

<Tab>
