#:kivy 1.11.0
#:import sp kivy.metrics.sp
#:import dp kivy.metrics.dp
#:import data_manager data_manager
#:import NewAddress screens.new_address_screen.NewAddress
#:import SendCoins screens.send_coins.SendCoins
#:import IngestInvoicesScreen screens.ingest_invoices_screen.IngestInvoicesScreen

########################################################################################
# MAIN
########################################################################################

<MainLayout>:
    id: main_layout
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: 35 / 255, 35 / 255, 35 / 255, 1
        Rectangle:
            pos: self.pos
            size: self.size
    MainMenu_ActionBar:
        id: ActionBar
    BoxLayout:
        orientation: "vertical"
        size: root.width, root.height
        canvas.before:
            Color:
                rgba: 1, 0, 0, (0.1 * (app.config['debug']['layouts'] == '1'))
            Rectangle:
                pos: self.pos
                size: self.size
        ScreenManager:
            id: sm
            canvas.before:
                Color:
                    rgba: 0, 1, 1, (0.1 * (app.config['debug']['layouts'] == '1'))
                Rectangle:
                    pos: self.pos
                    size: self.size
            ChannelsScreen:
                id: channels
            PayScreen
            ConnectScreen
            OpenChannelScreen
            FirstScreen
            MailScreen
            ConsoleScreen
        StatusLine
            id: status_line

########################################################################################
# STATUS LINE IO
########################################################################################

<StatusLineInput>
    id: input
    multiline: False
    on_text_validate: root.got_input(self.text)
    text: ''
    foreground_color: 1, 1, 1, 1
    background_color: (70 / 255, 70 / 255, 70 / 255, 1) if self.focus else (55 / 255, 55 / 255, 55 / 255, 1)

<StatusLineOutput>
    text: root.output
    multiline: False
    foreground_color: 1, 1, 1, 1
    background_color: (70 / 255, 70 / 255, 70 / 255, 1) if self.focus else (55 / 255, 55 / 255, 55 / 255, 1)


########################################################################################
# STATUS LINE
########################################################################################

<StatusLine>
    id: status_line
    height: 50
    size_hint_y: None
    orientation: 'horizontal'
    canvas.before:
        Color:
            rgba: 55 / 255, 55 / 255, 55 / 255, 1
        Rectangle:
            pos: self.pos
            size: self.size
    MDRaisedButton:
        text: 'se'
        size_hint_x: None
        width: 30
        size_hint_y: 1
        md_bg_color: 0.3,0.3,0.3,1
        on_release: app.root.ids.sm.current = 'console'
    StatusLineInput:
        id: line_input
    Button:
        disabled: 1
        width: 2
        size_hint_x: None
    StatusLineOutput:
        id: line_output

########################################################################################
# ATTRIBUTE EDITOR
########################################################################################

<FeeRateSlider>:
    BoxLayout:
        orientation: 'vertical'
        height: 200
        size_hint_y: None
        size_hint_x: None
        pos: root.pos
        width: root.width
        Label:
            text: 'Fee rate ppm'
        MDSlider:
            id: slider
            min: 0
            step: 5
            on_touch_up: root.slider_up(int(self.value))
            hint: True
        MDTextField:
            text: str(int(slider.value))

<AEFees>:
    BoxLayout:
        orientation: 'vertical'
        height: 500
        size_hint_y: None
        size_hint_x: None
        pos: root.pos
        width: root.width
        Label:
            text: "         "
        Label:
            text: "Fees:"
        MDTextField:
            text: str(root.fee_rate_milli_msat)
            helper_text: 'Fee Rate Milli Msat'
            helper_text_mode: "persistent"
            on_text_validate: root.fee_rate_milli_msat_changed(self.text)
        MDTextField:
            text: str(root.fee_base_msat)
            helper_text: 'Fee Base Msat'
            helper_text_mode: "persistent"
            on_text_validate: root.fee_base_msat_changed(self.text)
        MDTextField:
            text: str(root.min_htlc)
            helper_text: 'Min HTLC msat'
            helper_text_mode: "persistent"
            on_text_validate: root.min_htlc_changed(self.text)
        MDTextField:
            text: str(root.max_htlc_msat)
            helper_text: 'Max HTLC msat'
            helper_text_mode: "persistent"
            on_text_validate: root.max_htlc_msat_changed(self.text)
        MDTextField:
            text: str(root.time_lock_delta)
            helper_text: 'Time Lock Delta'
            helper_text_mode: "persistent"
            on_text_validate: root.time_lock_delta_changed(self.text)

<AEChannel@GridLayout>:
    cols: 1
    size_hint_y: None
    height: 5000
    canvas.before:
        Color:
            rgba: .3, .3, .4, .3
        Rectangle:
            size: self.size
            pos: self.pos
    Label:
        text: '         '
    AEFees:
        channel: root.channel
        height: 500
        size_hint_y: None
        size_hint_x: None
        width: root.width

<AttributeEditor>
    ScrollView:
        canvas.before:
            Color:
                rgba: 1, .3, .4, (0.1 * (app.config['debug']['layouts'] == '1'))
            Rectangle:
                size: self.size
                pos: self.pos
        id: ae_scroll_view
        size_hint: 1, 1
        pos_hint: {'center_x': .5, 'center_y': .5}
        do_scroll_x: False
        do_scroll_y: True

########################################################################################
# MENU BAR
########################################################################################


<MainMenu_ActionBar@ActionBar>:
    height: 50
    size_hint_y: None
    ActionView:
        id: ActionView
        HiddenIcon_ActionPrevious:
        ActionGroup:
            id: App_ActionGroup
            mode: 'spinner'
            font_size: '12sp'
            text: '       Lightning         '
            font_name: 'DejaVuSans'
            ActionButton:
                text: 'Channels'
                font_size: '12sp'
                on_release:  app.root.ids.sm.current = 'channels'
            ActionButton:
                text: 'Pay'
                font_size: '12sp'
                on_release:  app.root.ids.sm.current = 'pay'
            ActionButton:
                text: 'Mail'
                font_size: '12sp'
                on_release:  app.root.ids.sm.current = 'mail'
            ActionButton:
                text: 'Open Channel'
                font_size: '12sp'
                on_release:  app.root.ids.sm.current = 'open_channel'
            ActionButton:
                text: 'Connect'
                font_size: '12sp'
                on_release:  app.root.ids.sm.current = 'connect'
            ActionButton:
                text: 'Ingest Invoices'
                font_size: '12sp'
                on_release: IngestInvoicesScreen().open()
        ActionGroup:
            id: App_ActionGroup
            mode: 'spinner'
            text: '  On-Chain  '
            font_name: 'DejaVuSans'
            font_size: '12sp'
            ActionButton:
                text: 'New Address'
                font_size: '12sp'
                on_release: NewAddress().open()
            ActionButton:
                text: 'Send Coins'
                font_size: '12sp'
                on_press: SendCoins().open()
        ActionGroup:
            id: App_ActionGroup
            mode: 'spinner'
            text: 'App'
            font_name: 'DejaVuSans'
            font_size: '12sp'
            ActionButton:
                text: 'Settings'
                font_size: '12sp'
                on_press: app.open_settings()
            ActionButton:
                text: 'Quit'
                font_size: '12sp'
                on_press: app.get_running_app().stop()
        ActionButton:
            text: 'Refresh'
            font_name: 'DejaVuSans'
            font_size: '12sp'
            on_press: app.root.ids.sm.get_screen("channels").refresh()
        ActionGroup:
            id: scripts
            font_size: '12sp'
            text: '     Scripts     '
            font_name: 'DejaVuSans'
            mode: 'spinner'
            # ActionButton:
            #     text: 'Example'
            #     font_size: '12sp'

<HiddenIcon_ActionPrevious@ActionPrevious>:
    title: ''   # app.title if app.title is not None else 'Action Previous'
    with_previous: False
    app_icon: ''
    app_icon_width: 0
    app_icon_height: 0
    size_hint_x: None
    width: len(self.title) * 10

########################################################################################
# CHANNELS
########################################################################################

<ChannelsWidget>:
    canvas.before:
        Color:
            rgba: 0, 0, 1, (0.1 * (app.config['debug']['layouts'] == '1'))
        Rectangle:
            size: self.size
    RelativeLayout:
        canvas.before:
            Color:
                rgba: 0, 1, 0, (0.1 * (app.config['debug']['layouts'] == '1'))
            Rectangle:
                size: [root.size[0]*10, root.size[1]*10]
                pos: -10000, -10000
        id: relative_layout
        pos: [root.width/1.9, root.height/2]

<ChannelsScreen>:
    name: 'channels'
    BoxLayout:
        id: box_layout
        orientation: 'horizontal'
        canvas:
            Color:
                rgba: .2, .2, .3, 1
            Rectangle:
                size: self.size
                pos: self.pos
        RelativeLayout:
            id: cw_layout
            size_hint_x: 0.8
        AttributeEditor:
            id: attribute_editor
            size_hint_x: 0.2
    HUD:
        id: hud

<ChannelWidget>:

<FeeWidget>:

########################################################################################
# HUD
########################################################################################

<HUD1>:
    size_hint_y: None
    height: hud_label.height
    width: hud_label.width
    Label:
        canvas.before:
            Color:
                rgba: .3, .3, .4, .3
            Rectangle:
                size: self.size
                pos: self.pos
            Color:
                rgba: .6, .6, .8, 1
            Line:
                points: [self.pos[0]+self.width, self.pos[1], self.pos[0]+self.width, self.pos[1] + self.height]
                width: 1
            Line:
                points: [self.pos[0], self.pos[1], self.pos[0], self.pos[1] + self.height]
                width: 1
            Line:
                points: [self.pos[0], self.pos[1], self.pos[0] + self.width, self.pos[1]]
                width: 1
            Line:
                points: [self.pos[0], self.pos[1] + self.height, self.pos[0] + self.width, self.pos[1] + self.height]
                width: 1

        id: hud_label
        pos: [root.pos[0]+2, root.pos[1]+2]
        text: root.hud
        size_hint: [None, None]
        markup: True
        size: [self.texture_size[0]+40, self.texture_size[1]+30]

<HUD2>:
    size_hint_y: 1
    pos: [0, self.height-hud_label.height]
    width: hud_label.width
    Label:
        canvas.before:
            Color:
                rgba: .3, .3, .4, .3
            Rectangle:
                size: self.size
                pos: self.pos
            Color:
                rgba: .6, .6, .8, 1
            Line:
                points: [self.pos[0]+self.width, self.pos[1], self.pos[0]+self.width, self.pos[1] + self.height]
                width: 1
            Line:
                points: [self.pos[0], self.pos[1], self.pos[0], self.pos[1] + self.height]
                width: 1
            Line:
                points: [self.pos[0], self.pos[1], self.pos[0] + self.width, self.pos[1]]
                width: 1
            Line:
                points: [self.pos[0], self.pos[1] + self.height, self.pos[0] + self.width, self.pos[1] + self.height]
                width: 1
        id: hud_label
        pos: [root.pos[0]+2, root.pos[1]-2]
        text: root.hud
        size_hint: [None, None]
        markup: True
        size: [self.texture_size[0]+40, self.texture_size[1]+30]


<HUD>:
    size_hint: [1, 1]
    HUD1
    HUD2

########################################################################################
# PATH FINDING
########################################################################################

<PathFindingLayout>:
    canvas:
        Color:
            rgb: .2, .2, .2
        Rectangle:
            size: self.size
            pos: self.pos
    PathFindingWidget:


########################################################################################
# PAY
########################################################################################

<PayScreen>:
    name: 'pay'
    GridLayout:
        cols: 1
        padding: 50
        spacing: 50
        BoxLayout:
            size_hint_y: None
            height: 60
            orientation: 'horizontal'
            Label:
                text: "Fee rate PPM"
                font_name: 'DejaVuSans'
                font_size: '24sp'
                size_hint_y: None
                height: 60
                canvas.before:
                    PushMatrix
                    Scale:
                        origin: self.center
                        xyz: .5, .5, 1
                canvas.after:
                    PopMatrix
            TextInput:
                id: fee_rate
                multiline: False
                size_hint_y: None
                text: '500'
                height: 60
                font_size: '12sp'
        # PathFindingLayout:
        ScrollView:
            size_hint: 0.5, 1
            pos_hint: {'center_x': .5, 'center_y': .5}
            do_scroll_x: False
            GridLayout:
                id: output
                cols: 1
                padding: 50
                spacing: 50
                size_hint_y: None
                height: self.minimum_height
        Button:
            text: 'Pay'
            font_name: 'DejaVuSans'
            font_size: '12sp'
            on_release: root.pay() 
            size_hint_y: None
            height: 60
        Button:
            text: 'Kill'
            font_size: '12sp'
            font_name: 'DejaVuSans'
            size_hint_y: None
            height: 60

########################################################################################
# MAIL
########################################################################################

<MailScreen>:
    name: 'mail'
    ScrollView:
        size_hint: 0.5, 1
        pos_hint: {'center_x': .5, 'center_y': .5}
        do_scroll_x: False
        GridLayout:
            id: inbox
            cols: 1
            padding: 50
            spacing: 50
            size_hint_y: None
            height: self.minimum_height

########################################################################################
# OPEN CHANNEL
########################################################################################

<OpenChannelScreen>:
    name: 'open_channel'
    GridLayout:
        cols: 1
        row_force_default: True
        row_default_height: 60
        padding: 50
        spacing: 50
        BoxLayout:
            orientation: 'horizontal'
            Label:
                text: 'Pubkey'
            TextInput:
                id: pk
                size_hint_y: 1
        BoxLayout:
            orientation: 'horizontal'
            Label:
                text: 'Sats'
            TextInput:
                id: sats
                size_hint_y: 1
        BoxLayout:
            orientation: 'horizontal'
            Label:
                text: 'Sats per v/byte'
            TextInput:
                id: sats_per_vbyte
                size_hint_y: 1
        Button:
            text: 'open'
            on_release: root.open_channel(pk.text, sats.text, sats_per_vbyte.text)


########################################################################################
# CONNECT
########################################################################################

<ConnectScreen>:
    name: 'connect'
    GridLayout:
        cols: 1
        row_force_default: True
        row_default_height: 60
        padding: 50
        spacing: 50
        Label:
            text: "Connection with node is required before a channel can be opened."
        BoxLayout:
            orientation: 'horizontal'
            Label:
                text: 'Address'
            TextInput:
                id: address
                size_hint_y: 1
        Button:
            text: 'Address'
            on_release: root.connect(address.text)

########################################################################################
# CONSOLE SCREEN
########################################################################################

<ConsoleInput>:
    id: text_input
    multiline: True
    size_hint_y: 1
    foreground_color: 1, 1, 1, 1
    background_color: (70 / 255, 70 / 255, 70 / 255, 1) if self.focus else (55 / 255, 55 / 255, 55 / 255, 1)

<ConsoleOutput>:
    id: console_output
    text: root.output
    # disabled: 1
    multiline: True
    size_hint_y: 1
    foreground_color: 1, 1, 1, 1
    background_color: (70 / 255, 70 / 255, 70 / 255, 1) if self.focus else (55 / 255, 55 / 255, 55 / 255, 1)


<ConsoleScreen>:
    name: 'console'
    BoxLayout:
        orientation: 'vertical'
        ConsoleInput:
            id: console_input
        ConsoleOutput:
            id: console_output

<InstallScript>
    size: (500,250)
    size_hint: (None, None)
    title: 'Install Script'
    BoxLayout:
        orientation: 'vertical'
        TextInput:
            id: script_name
            text: 'example'
        BoxLayout:
            orientation: 'horizontal'
            Button:
                id: install
                text: 'Install'
<LoadScript>
    size: (500,800)
    size_hint: (None, None)
    title: 'Load Script'
    ScrollView:
        size_hint: 1, 1
        pos_hint: {'center_x': .5, 'center_y': .5}
        GridLayout:
            id: grid
            cols: 1
            padding: 10
            spacing: 10
            size_hint: None, None
            height: self.minimum_height
            do_scroll_x: False

<Project>:
    id: contextual
    ActionPrevious:
        title: "Return"
        width: 100
        with_previous: True
        on_release: app.root.ids.sm.current = 'channels'
    ActionOverflow:
    ActionButton:
        id: run
        text: 'Run'
    ActionButton:
        id: load
        text: 'Load'
    ActionButton:
        id: install
        text: 'Install'
