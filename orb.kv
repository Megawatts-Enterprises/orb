#:kivy 1.11.0
#:import sp kivy.metrics.sp
#:import dp kivy.metrics.dp
#:import data_manager data_manager
#:import NewAddress screens.new_address_screen.NewAddress
#:import SendCoins screens.send_coins.SendCoins
#:import IngestInvoicesScreen screens.ingest_invoices_screen.IngestInvoicesScreen
#:import PayScreen screens.pay_screen.PayScreen
#:import ConnectScreen screens.connect_screen.ConnectScreen
#:import OpenChannelScreen screens.open_channel_screen.OpenChannelScreen
#:import CloseChannel screens.close_channel.CloseChannel
#:import Rebalance screens.rebalance.Rebalance
#:import prefs_col utils.prefs_col
#:import download_forwarding_history forwarding_history.download_forwarding_history
#:import view_forwarding_history forwarding_history.view_forwarding_history
#:import graph_fees_earned forwarding_history.graph_fees_earned
########################################################################################
# MAIN
########################################################################################

<TopMenu@AppMenu>:

<MainLayout>:
    id: main_layout
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: 35 / 255, 35 / 255, 35 / 255, 1
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        id: box_layout
        orientation: "vertical"
        size: root.width, root.height
        canvas.before:
            Color:
                rgba: 1, 0, 0, (0.1 * (app.config['debug']['layouts'] == '1'))
            Rectangle:
                pos: self.pos
                size: self.size
        ScreenManager:
            id: sm
            canvas.before:
                Color:
                    rgba: 0, 1, 1, (0.1 * (app.config['debug']['layouts'] == '1'))
                Rectangle:
                    pos: self.pos
                    size: self.size
            ChannelsScreen:
                id: channels
            MailScreen
            ConsoleScreen
        StatusLine
            id: status_line
    TopMenu:
        id: app_menu
        top: root.height
        cancel_handler_widget: main_layout

        AppMenuTextItem:
            text: "View"
        AppMenuTextItem:
            text: "Lightning"
            ContextMenu:
                ContextMenuTextItem:
                    text: "Channels"
                    on_release: app_menu.close_all()
                    on_press: app.root.ids.sm.current = 'channels'
                ContextMenuTextItem:
                    text: "Pay"
                    on_release: app_menu.close_all()
                    on_press:  PayScreen().open()
                ContextMenuTextItem:
                    text: "Rebalance"
                    on_release: app_menu.close_all()
                    on_press:  Rebalance().open()
                ContextMenuTextItem:
                    text: "Mail"
                    on_press:  app.root.ids.sm.current = 'mail'
                    on_release: app_menu.close_all()
                ContextMenuTextItem:
                    text: "Open Channel"
                    on_press:  OpenChannelScreen().open()
                    on_release: app_menu.close_all()
#                ContextMenuTextItem:
#                    text: "Close Channel"
#                    on_press:  CloseChannel().open()
                    on_release: app_menu.close_all()
                ContextMenuTextItem:
                    text: "Connect"
                    on_press:  ConnectScreen().open()
                    on_release: app_menu.close_all()
                ContextMenuTextItem:
                    text: "Console"
                    on_press:  app.root.ids.sm.current = 'console'
                    on_release: app_menu.close_all()
                ContextMenuTextItem:
                    text: "Ingest Invoices"
                    on_press: IngestInvoicesScreen().open()
                    on_release: app_menu.close_all()
                ContextMenuTextItem:
                    text: "Forwarding History"
                    ContextMenu:
                        ContextMenuTextItem:
                            text: "Download"
                            on_press: download_forwarding_history()
                            on_release: app_menu.close_all()
                        ContextMenuTextItem:
                            text: "View"
                            on_press: view_forwarding_history()
                            on_release: app_menu.close_all()
                        ContextMenuTextItem:
                            text: "Fees earned"
                            on_press: graph_fees_earned()
                            on_release: app_menu.close_all()
        AppMenuTextItem:
            text: "On-Chain"
            ContextMenu:
                ContextMenuTextItem:
                    text: "New Address"
                    on_press: app_menu.close_all()
                    on_release: NewAddress().open()
                ContextMenuTextItem:
                    text: "Send Coins"
                    on_press: app_menu.close_all()
                    on_release: SendCoins().open()
        AppMenuTextItem:
            text: "App"
            ContextMenu:
                ContextMenuTextItem:
                    text: "Settings"
                    on_press: app_menu.close_all()
                    on_release: app.open_settings()
                ContextMenuTextItem:
                    text: "Quit"
                    on_press: app_menu.close_all()
                    on_release: app.get_running_app().stop()
        AppMenuTextItem:
            text: "Scripts"
            id: scripts



########################################################################################
# STATUS LINE IO
########################################################################################

<StatusLineInput>
    id: input
    multiline: False
    on_text_validate: root.got_input(self.text)
    text: ''
    foreground_color: 1, 1, 1, 1
    background_color: (70 / 255, 70 / 255, 70 / 255, 1) if self.focus else (55 / 255, 55 / 255, 55 / 255, 1)

<StatusLineOutput>
    text: root.output
    multiline: False
    foreground_color: 1, 1, 1, 1
    background_color: (70 / 255, 70 / 255, 70 / 255, 1) if self.focus else (55 / 255, 55 / 255, 55 / 255, 1)


########################################################################################
# STATUS LINE
########################################################################################

<StatusLine>
    id: status_line
    height: 50
    size_hint_y: None
    orientation: 'horizontal'
    canvas.before:
        Color:
            rgba: 55 / 255, 55 / 255, 55 / 255, 1
        Rectangle:
            pos: self.pos
            size: self.size
    MDRaisedButton:
        text: 'se'
        size_hint_x: None
        width: 30
        size_hint_y: 1
        md_bg_color: 0.3,0.3,0.3,1
        on_release: app.root.ids.sm.current = 'console'
    StatusLineInput:
        id: line_input
    Button:
        disabled: 1
        width: 2
        size_hint_x: None
    StatusLineOutput:
        id: line_output

########################################################################################
# ATTRIBUTE EDITOR
########################################################################################

<AEFees>:
    BoxLayout:
        orientation: 'vertical'
        height: 500
        size_hint_y: None
        size_hint_x: None
        pos: root.pos
        width: root.width
        Label:
            text: "         "
        Label:
            text: "Fees:"
        MDTextField:
            text: str(root.fee_rate_milli_msat)
            helper_text: 'Fee Rate Milli Msat'
            helper_text_mode: "persistent"
            on_text_validate: root.fee_rate_milli_msat_changed(self.text)
        MDTextField:
            text: str(root.fee_base_msat)
            helper_text: 'Fee Base Msat'
            helper_text_mode: "persistent"
            on_text_validate: root.fee_base_msat_changed(self.text)
        MDTextField:
            text: str(root.min_htlc)
            helper_text: 'Min HTLC msat'
            helper_text_mode: "persistent"
            on_text_validate: root.min_htlc_changed(self.text)
        MDTextField:
            text: str(root.max_htlc_msat)
            helper_text: 'Max HTLC msat'
            helper_text_mode: "persistent"
            on_text_validate: root.max_htlc_msat_changed(self.text)
        MDTextField:
            text: str(root.time_lock_delta)
            helper_text: 'Time Lock Delta'
            helper_text_mode: "persistent"
            on_text_validate: root.time_lock_delta_changed(self.text)

<AEChannel@GridLayout>:
    cols: 1
    size_hint_y: None
    height: 5000
    canvas.before:
        Color:
            rgba: .3, .3, .4, .3
        Rectangle:
            size: self.size
            pos: self.pos
    Label:
        text: '         '
    AEFees:
        channel: root.channel
        height: 500
        size_hint_y: None
        size_hint_x: None
        width: root.width

<AttributeEditor>
    ScrollView:
        canvas.before:
            Color:
                rgba: 1, .3, .4, (0.1 * (app.config['debug']['layouts'] == '1'))
            Rectangle:
                size: self.size
                pos: self.pos
        id: ae_scroll_view
        size_hint: 1, 1
        pos_hint: {'center_x': .5, 'center_y': .5}
        do_scroll_x: False
        do_scroll_y: True


########################################################################################
# CHANNELS
########################################################################################

<ChannelsWidget>:
    size_hint: 2, 2
    pos: [-self.width/4, -self.height/4]
    canvas:
        Color:
            rgba: 0, 1, 0, (0.1 * (app.config['debug']['layouts'] == '1'))
        Rectangle:
            size: self.size
    RelativeLayout:
        id: relative_layout
        size: [0, 0]
        pos: [root.size[0]/2, root.size[1]/2]
        size_hint: None, None
        canvas:
            Color:
                rgba: 1, 0, 0, (0.1 * (app.config['debug']['layouts'] == '1'))
            Rectangle:
                pos: self.pos
                size: self.size

<ChannelsScreen>:
    name: 'channels'
    BoxLayout:
        id: box_layout
        orientation: 'horizontal'
        canvas:
            Color:
                rgba: prefs_col('display.channels_background_color')
            Rectangle:
                size: self.size
                pos: self.pos
        RelativeLayout:
            id: cw_layout
            size_hint_x: 0.8
        AttributeEditor:
            id: attribute_editor
            size_hint_x: 0.2
    HUD:
        id: hud

<ChannelWidget>:

<FeeWidget>:

########################################################################################
# PATH FINDING
########################################################################################

<PathFindingLayout>:
    canvas:
        Color:
            rgb: .2, .2, .2
        Rectangle:
            size: self.size
            pos: self.pos
    PathFindingWidget:

########################################################################################
# MAIL
########################################################################################

<MailScreen>:
    name: 'mail'
    ScrollView:
        size_hint: 0.5, 1
        pos_hint: {'center_x': .5, 'center_y': .5}
        do_scroll_x: False
        GridLayout:
            id: inbox
            cols: 1
            padding: 50
            spacing: 50
            size_hint_y: None
            height: self.minimum_height

